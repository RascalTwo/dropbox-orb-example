version: 2.1

orbs:
  python: circleci/python@0.2.1
  dropbox: rascaltwo/dropbox-orb@dev:alpha


workflows:
  main:
    jobs:
      - download-previous:
          context: dropbox-context
      - execute:
          requires:
            - download-previous
      - upload-incremental:
          context: dropbox-context
          requires:
            - execute
      - upload-latest:
          context: dropbox-context
          requires:
            - upload-incremental

jobs:
  download-previous:
    executor: dropbox/default
    steps:
      - dropbox/download:
          downloadpath: /appending.csv
          filepath: ./appending.csv
      - persist_to_workspace:
          root: ~/
          paths:
            - ./
  execute:
    executor: python/default
    steps:
      - checkout
      - python/load-cache
      - python/install-deps
      - python/save-cache
      - run:
          command: |
            RES=$(./app.py)
            export LAST_LINE=$(echo $RES | sed -n '1!p')
            echo 'export FILE_PATH="./$LAST_LINE"' >> $BASH_ENV
            echo 'export UPLOAD_PATH="/$LAST_LINE"' >> $BASH_ENV
            source $BASH_ENV
            echo "$BASH_ENV"
            echo "$RES"
          name: Execute
      - persist_to_workspace:
          root: ~/
          paths:
            - ./
  upload-latest:
    executor: dropbox/default
    steps:
      - dropbox/upload
    environment:
      UPLOAD_PATH: /appending.csv
      FILE_PATH: ./appending.csv
  upload-incremental:
    executor: dropbox/default
    steps:
      - dropbox/upload