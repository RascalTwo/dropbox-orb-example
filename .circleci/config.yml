version: 2.1

orbs:
  python: circleci/python@0.2.1
  dropbox: rascaltwo/dropbox-orb@dev:alpha


workflows:
  main:
    jobs:
      - download-previous:
          context: dropbox-context
      - execute:
          requires:
            - download-previous
      - upload-latest:
          context: dropbox-context
          requires:
            - execute

jobs:
  download-previous:
    executor: dropbox/default
    steps:
      - dropbox/download:
          downloadpath: /appending.csv
          filepath: ./appending.csv
  upload-incremental:
    executor: dropbox/default
    steps:
      - dropbox/upload:
          uploadpath: /appending.csv
          filepath: ./appending.csv
  execute:
    executor: python/default
    steps:
      - checkout
      - python/load-cache
      - python/install-deps
      - python/save-cache
      - run:
          command: |
            RES=$(./app.py)
            export LAST_LINE=$(echo $RES | sed -n '1!p')
            echo 'export NEW_FILENAME=$LAST_LINE' >> BASH_ENV
            echo "$RES"
          name: Execute
  upload-latest:
    executor: dropbox/default
    steps:
      - dropbox/upload:
          uploadpath: /$LAST_LINE
          filepath: ./$LAST_LINE